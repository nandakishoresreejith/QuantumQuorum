<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumQuorum - A Forum for Quantum Computing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Custom styles for the Discourse-like theme */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }
        .page { display: none; }
        .page.active { display: block; }

        .sidebar-link.active {
            background-color: #374151; /* gray-700 */
            color: #ffffff;
        }
        .category-box {
            border-left-width: 4px;
        }
        .main-content {
            background-color: #1f2937; /* gray-800 */
        }
        .topic-link:hover {
            background-color: #374151; /* gray-700 */
        }
        .answer-toggle { display: none; }
        .vote-btn.active svg {
            color: #60a5fa; /* blue-400 */
        }
        #helper-bot-container {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        #helper-bot-container.open {
            transform: translateY(0);
        }
        .gate {
            cursor: grab;
        }
        .circuit-line {
            border-bottom: 2px solid #4b5563; /* gray-600 */
            min-height: 50px;
            position: relative;
        }
        .gate-placeholder {
            position: absolute;
        }
        .leaderboard-link.active {
            color: #fff;
            border-bottom: 2px solid #fff;
        }
        
        /* Message Container */
        .message-container {
            background-color: #1f2937;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Message Header */
        .message-header {
            font-size: 1.25rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 1.5rem;
        }
        /* Individual Replies */
        .reply-card {
            border-left: 4px solid;
            padding-left: 1rem;
        }
        .reply-card.border-blue-500 { border-color: #3b82f6; }
        .reply-card.border-green-500 { border-color: #22c55e; }
        .reply-card.border-yellow-500 { border-color: #f59e0b; }
        .reply-card .user-info {
            font-weight: bold;
            color: #60a5fa;
        }
        .reply-card .reply-body {
            color: #d1d5db;
        }

        /* Light Theme Overrides */
        html:not(.dark) body {
            background-color: #ffffff;
            color: #1f2937;
        }
        html:not(.dark) .main-content {
            background-color: #f3f4f6;
        }
        html:not(.dark) #sidebar,
        html:not(.dark) header {
            background-color: #f9fafb;
            color: #1f2937;
            border-bottom: 1px solid #e5e7eb;
        }
        html:not(.dark) #sidebar .sidebar-link {
             color: #4b5563;
        }
        html:not(.dark) .sidebar-link.active {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        html:not(.dark) .sidebar-link:hover {
            background-color: #e5e7eb;
        }
        html:not(.dark) .category-box,
        html:not(.dark) .bg-gray-900\/50,
        html:not(.dark) .message-container {
            background-color: #ffffff;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        html:not(.dark) .topic-link:hover {
            background-color: #e5e7eb;
        }
        html:not(.dark) .leaderboard-link.active {
            color: #1f2937;
            border-color: #1f2937;
        }
        html:not(.dark) .border-gray-700 {
            border-color: #e5e7eb;
        }
        html:not(.dark) .text-white,
        html:not(.dark) .message-header,
        html:not(.dark) .text-gray-200,
        html:not(.dark) .text-gray-300 {
            color: #1f2937;
        }
        html:not(.dark) .text-gray-400 {
            color: #6b7280;
        }
        html:not(.dark) .text-gray-500 {
            color: #9ca3af;
        }
        html:not(.dark) .bg-gray-800,
        html:not(.dark) .bg-gray-700 {
            background-color: #e5e7eb;
        }
        html:not(.dark) #search-input {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        html:not(.dark) #search-input::placeholder {
            color: #9ca3af;
        }
        html:not(.dark) .go-back-btn {
            color: #6b7280;
        }
        html:not(.dark) .go-back-btn:hover {
            color: #1f2937;
        }
        html:not(.dark) input, html:not(.dark) textarea, html:not(.dark) select {
            background-color: #f9fafb;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        html:not(.dark) .prose-invert {
            color: #1f2937;
        }
        html:not(.dark) .prose-invert h3 {
            color: #1f2937;
        }
        html:not(.dark) pre {
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
        }
        html:not(.dark) code {
            color: #1f2937;
        }
        /* Home page tabs styling */
        .tab-btn {
            @apply py-2 px-4 rounded-lg font-semibold border-2 border-transparent;
        }
        .tab-btn.tab-active {
            @apply bg-blue-600 text-white border-blue-600;
        }
        .tab-btn:not(.tab-active) {
            @apply bg-gray-700 text-gray-300 hover:bg-gray-600;
        }
        html:not(.dark) .tab-btn.tab-active {
            @apply bg-indigo-600 text-white border-indigo-600;
        }
        html:not(.dark) .tab-btn:not(.tab-active) {
            @apply bg-gray-300 text-gray-700 hover:bg-gray-200;
        }
        .like-btn.liked .fa-heart {
            color: #ef4444; /* red-500 */
            font-weight: 900; /* Solid heart */
        }
    </style>
</head>
<body class="text-sm">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-72 bg-gray-900 text-gray-300 flex-shrink-0 p-4 space-y-6 overflow-y-auto">
            <div>
                <h2 class="text-lg font-bold text-white mb-2">QuantumQuorum</h2>
                <nav class="space-y-1">
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link active" data-page="home">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Home
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="messages">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        Messages
                    </a>
                </nav>
            </div>

            <div>
                <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Categories</h3>
                <nav id="sidebar-categories" class="mt-2 space-y-1">
                    <!-- Categories will be dynamically inserted here from Firestore -->
                </nav>
            </div>

            <div>
                <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Resources</h3>
                <nav class="mt-2 space-y-1">
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="members">
                        <i class="fa-solid fa-users w-5 h-5 mr-3"></i>
                        Members
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="facultyCorner">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.197-5.975M7 10a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        Faculty Corner
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="researchPapers">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Research Papers
                    </a>
                     <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="docs">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        Docs
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="news">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h3m-3 4h3m-3 4h3m-3 4h3"></path></svg>
                        News
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="team">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Team Finder
                    </a>
                </nav>
            </div>
            
            <div>
                <h3 class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Interactive</h3>
                <nav class="mt-2 space-y-1">
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="challenges">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4M17 3v4m2-2h-4m2 14h4m-2-2v4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path></svg>
                        Challenges
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="leaderboard">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Leaderboard
                    </a>
                    <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="projects">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        Projects
                    </a>
                </nav>
            </div>

            <!-- New Settings Link -->
            <div class="mt-auto">
                <a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="settings">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.82 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.82 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.82-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.82-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header class="bg-gray-900 flex-shrink-0">
                <div class="flex items-center justify-between h-16 px-6">
                    <div>
                        <button class="go-back-btn hidden items-center text-gray-400 hover:text-white">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Back
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <form id="search-form" class="relative">
                            <input id="search-input" type="search" placeholder="Search topics..." class="bg-gray-700 text-white placeholder-gray-400 rounded-md py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </form>
                        <button id="ask-question-header-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">
                            Ask Question
                        </button>
                        <div id="user-auth-container" class="flex items-center space-x-2">
                           <!-- Auth buttons or user avatar will be loaded here -->
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-6 main-content">
                <!-- Pages will be rendered here -->
                <div id="homePage" class="page active"></div>
                <div id="questionListPage" class="page"></div>
                <div id="questionDetailPage" class="page"></div>
                <div id="facultyCornerPage" class="page"></div>
                <div id="researchPapersPage" class="page"></div>
                <div id="researchPaperDetailPage" class="page"></div>
                <div id="docsPage" class="page"></div>
                <div id="docDetailPage" class="page"></div>
                <div id="newsPage" class="page"></div>
                <div id="newsDetailPage" class="page"></div>
                <div id="teamPage" class="page"></div>
                <div id="membersPage" class="page"></div>
                <div id="userProfilePage" class="page"></div>
                <div id="activityPage" class="page"></div>
                <div id="messagesPage" class="page"></div>
                <div id="messageDetailPage" class="page"></div>
                <div id="searchResultsPage" class="page"></div>
                <div id="challengesPage" class="page"></div>
                <div id="challengeDetailPage" class="page"></div>
                <div id="leaderboardPage" class="page"></div>
                <div id="projectsPage" class="page"></div>
                <div id="projectDetailPage" class="page"></div>
                <div id="settingsPage" class="page"></div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="signUpModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="logInModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="docViewerModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="summaryModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="askQuestionModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="editQuestionModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4 overflow-y-auto"></div>
    <div id="messageFacultyModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="uploadPaperModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="editPaperModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="uploadDocModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="postNewsModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="createTeamModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="addProjectModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>


    <!-- Helper Bot -->
    <div id="helper-bot-container" class="fixed bottom-0 right-8 w-80 bg-gray-800 border-t border-l border-r border-gray-700 rounded-t-lg shadow-2xl z-40">
        <div class="p-4">
            <h3 class="font-bold text-white mb-2">How can I help you?</h3>
            <p class="text-xs text-gray-400 mb-4">Quickly navigate to any of our key resource pages.</p>
            <div id="helper-bot-links" class="grid grid-cols-2 gap-2 text-center">
                <!-- Bot links will be inserted here -->
            </div>
        </div>
    </div>
    <button id="helper-bot-trigger" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700 z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 16.663c.527-.527.928-1.146 1.2-1.813M14.337 16.663c-.527-.527-.928-1.146-1.2-1.813M12 21c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9z"></path></svg>
    </button>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, getDoc, doc, addDoc, setDoc, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB6LZQRoUIsttz3rgTL3u7WzC6sSLCu8bY",
            authDomain: "quantum-e51b0.firebaseapp.com",
            projectId: "quantum-e51b0",
            storageBucket: "quantum-e51b0.appspot.com",
            messagingSenderId: "430851021652",
            appId: "1:430851021652:web:9b81ae3fbe26935ce646c1",
            measurementId: "G-5EEEH8093D"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // App state
        let currentUser = null;
        let users = {}; // Local cache for user data

        document.addEventListener('DOMContentLoaded', () => {
        
            // --- VARIABLE AND CONSTANT DECLARATIONS ---
            const pageElements = {
                home: document.getElementById('homePage'),
                questionList: document.getElementById('questionListPage'),
                questionDetail: document.getElementById('questionDetailPage'),
                facultyCorner: document.getElementById('facultyCornerPage'),
                researchPapers: document.getElementById('researchPapersPage'),
                researchPaperDetail: document.getElementById('researchPaperDetailPage'),
                docs: document.getElementById('docsPage'),
                docDetail: document.getElementById('docDetailPage'),
                news: document.getElementById('newsPage'),
                newsDetail: document.getElementById('newsDetailPage'),
                team: document.getElementById('teamPage'),
                members: document.getElementById('membersPage'),
                userProfile: document.getElementById('userProfilePage'),
                activity: document.getElementById('activityPage'),
                messages: document.getElementById('messagesPage'),
                messageDetail: document.getElementById('messageDetailPage'),
                searchResults: document.getElementById('searchResultsPage'),
                challenges: document.getElementById('challengesPage'),
                challengeDetail: document.getElementById('challengeDetailPage'),
                leaderboard: document.getElementById('leaderboardPage'),
                projects: document.getElementById('projectsPage'),
                projectDetail: document.getElementById('projectDetailPage'),
                settings: document.getElementById('settingsPage')
            };
            const settings = {
                theme: 'dark'
            };
            let pageHistory = [{page: 'home', id: null}];

            // --- AUTHENTICATION ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        currentUser = { uid: user.uid, ...userDocSnap.data() };
                    } else {
                        const newUserProfile = {
                            name: `User-${user.uid.substring(0, 5)}`,
                            email: user.email,
                            joinDate: serverTimestamp(),
                            avatar: `https://placehold.co/64x64/7c3aed/ffffff?text=${user.email[0].toUpperCase()}`,
                            level: 'Beginner',
                            points: 0,
                            isMentor: false
                        };
                        await setDoc(userDocRef, newUserProfile);
                        
                        // Also create a leaderboard entry
                        const leaderboardRef = doc(db, "leaderboard", user.uid);
                        await setDoc(leaderboardRef, {
                            name: newUserProfile.name,
                            avatar: newUserProfile.avatar,
                            topicsCreated: 0,
                            repliesPosted: 0,
                            solutions: 0
                        });

                        currentUser = { uid: user.uid, ...newUserProfile };
                    }
                } else {
                    currentUser = null;
                }
                updateUserAuthUI();
                navigateTo('home');
            });


            function updateUserAuthUI() {
                const container = document.getElementById('user-auth-container');
                if (currentUser) {
                    container.innerHTML = `
                        <img src="${currentUser.avatar}" class="w-8 h-8 rounded-full cursor-pointer nav-link" data-page="userProfile" data-id="${currentUser.uid}" alt="${currentUser.name}">
                        <button id="logout-btn" class="text-sm text-gray-400 hover:text-white">Logout</button>
                    `;
                } else {
                    container.innerHTML = `
                        <button id="login-btn" class="text-sm font-semibold text-white hover:underline">Log In</button>
                        <button id="signup-btn" class="bg-gray-700 hover:bg-gray-600 text-white text-sm font-semibold py-2 px-3 rounded-md">Sign Up</button>
                    `;
                }
            }
            
            // --- DATA FETCHING FUNCTIONS ---
            async function fetchAllData() {
                const usersSnapshot = await getDocs(collection(db, "users"));
                users = {};
                usersSnapshot.forEach(doc => {
                    users[doc.id] = { id: doc.id, ...doc.data() };
                });
            }

            // --- RENDER FUNCTIONS ---
            async function renderHomePage(filterType = 'latest') {
                const homePage = pageElements.home;
                const sidebarCategories = document.getElementById('sidebar-categories');
                
                const questionsQuery = query(collection(db, "questions"));
                const questionsSnapshot = await getDocs(questionsQuery);
                let questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const sortedByReplies = [...questions].sort((a, b) => (b.answers?.length || 0) - (a.answers?.length || 0));
                const topQuestions = sortedByReplies.slice(0, 4);

                homePage.innerHTML = `
                    <div class="mb-8">
                        <h2 class="text-xl font-bold text-white mb-4">Trending Topics</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${topQuestions.map(q => `
                                <a href="#" class="bg-gray-900/50 p-4 rounded-md hover:bg-gray-700/50 nav-link" data-page="questionDetail" data-id="${q.id}">
                                    <h3 class="font-semibold text-white truncate">${q.title}</h3>
                                    <div class="text-xs text-gray-400 mt-2 flex items-center space-x-4">
                                        <span>${q.answers?.length || 0} replies</span>
                                        <span>${q.votes || 0} votes</span>
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-6 text-gray-400 border-b border-gray-700 mb-8 mt-8">
                        <button class="py-2 leaderboard-link ${filterType === 'latest' ? 'active' : ''}" data-filter="latest">Latest</button>
                    </div>

                    <div id="all-questions-feed" class="mb-8"></div>
                    <div id="category-grid" class="space-y-4"></div>
                `;

                const allQuestionsFeed = document.getElementById('all-questions-feed');
                allQuestionsFeed.innerHTML = `<h2 class="text-xl font-bold text-white mb-4">All Questions & Discussions</h2>` + 
                questions.map(q => {
                    const author = users[q.authorId];
                    return `
                    <div class="bg-gray-900/50 p-4 rounded-md mb-4">
                        <h3 class="font-semibold text-white"><a href="#" class="nav-link hover:underline" data-page="questionDetail" data-id="${q.id}">${q.title}</a></h3>
                        <p class="text-xs text-gray-400 mt-1">Asked by ${author?.name || 'Unknown'}</p>
                        <div class="mt-3 border-t border-gray-700 pt-3 space-y-3">
                        ${(q.answers || []).slice(0,2).map(ans => {
                            const ansAuthor = users[ans.by];
                            if (!ansAuthor) return `<div class="text-xs"><strong class="text-blue-400">Unknown User:</strong> <span class="text-gray-300">${ans.body}</span></div>`
                            return `<div class="text-xs"><strong class="text-blue-400">${ansAuthor.name}:</strong> <span class="text-gray-300">${ans.body}</span></div>`
                        }).join('')}
                        ${(q.answers?.length || 0) > 2 ? `<a href="#" class="text-xs text-blue-400 hover:underline nav-link" data-page="questionDetail" data-id="${q.id}">View ${(q.answers.length) - 2} more replies...</a>` : ''}
                        ${(q.answers?.length || 0) === 0 ? `<p class="text-xs text-gray-500">No answers yet.</p>` : ''}
                        </div>
                    </div>
                    `
                }).join('');
                
                const categoryGrid = document.getElementById('category-grid');
                const categoriesSnapshot = await getDocs(collection(db, "categories"));
                const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                categoryGrid.innerHTML = `<h2 class="text-xl font-bold text-white mb-4">Categories</h2><div class="flex justify-between items-center mb-4 text-gray-400 font-semibold"><span class="w-2/3">Category</span><span class="w-1/3">Latest Topic</span></div>`;
                sidebarCategories.innerHTML = '';

                categories.forEach(cat => {
                    const catColor = cat.color || 'border-gray-500'; // Default color
                    const catQuestions = questions.filter(q => q.catId === cat.id);
                    const latestTopic = catQuestions.sort((a,b) => b.createdAt - a.createdAt)[0];
                    sidebarCategories.insertAdjacentHTML('beforeend', `<a href="#" class="flex items-center px-3 py-2 rounded-md hover:bg-gray-700 nav-link sidebar-link" data-page="questionList" data-id="${cat.id}"><span class="w-3 h-3 mr-3 rounded-sm ${catColor.replace('border-', 'bg-')}"></span>${cat.name}</a>`);
                    categoryGrid.insertAdjacentHTML('beforeend', `
                        <div class="category-box ${catColor} bg-gray-900/50 rounded-md flex">
                            <div class="flex-1 p-4 w-2/3">
                                <a href="#" class="text-lg font-bold text-white hover:underline nav-link" data-page="questionList" data-id="${cat.id}">${cat.name}</a>
                                <p class="text-gray-400 mt-1">${cat.description}</p>
                            </div>
                            <div class="w-1/3 p-4 border-l border-gray-700">
                                 ${latestTopic ? `<a href="#" class="flex items-center p-2 rounded-md topic-link nav-link text-gray-200 hover:text-white" data-page="questionDetail" data-id="${latestTopic.id}">
                                        <svg class="w-4 h-4 mr-2 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                                        <span class="truncate">${latestTopic.title}</span>
                                    </a>` : '<span class="text-gray-500 text-sm">No topics yet</span>'}
                            </div>
                        </div>`);
                });
            }

            async function renderQuestionListPage(categoryId) {
                const page = pageElements.questionList;
                
                const categoryDocRef = doc(db, "categories", categoryId);
                const categoryDocSnap = await getDoc(categoryDocRef);
                if (!categoryDocSnap.exists()) {
                    page.innerHTML = `<h1 class="text-2xl font-bold text-red-500">Category not found</h1>`;
                    return;
                }
                const category = categoryDocSnap.data();

                const q = query(collection(db, "questions"), where("catId", "==", categoryId));
                const querySnapshot = await getDocs(q);
                const questions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                page.innerHTML = `
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-white">${category.name}</h1>
                        <p class="text-gray-400 mt-1">${category.description}</p>
                    </div>
                    <div class="space-y-4">
                        ${questions.length > 0 ? questions.map(question => {
                            const author = users[question.authorId];
                            return `
                            <a href="#" class="block bg-gray-900/50 p-4 rounded-md hover:bg-gray-700/50 nav-link" data-page="questionDetail" data-id="${question.id}">
                                <div class="flex items-center">
                                    <img src="${author?.avatar || 'https://placehold.co/40x40'}" alt="${author?.name || 'Unknown'}" class="w-10 h-10 rounded-full mr-4">
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-white">${question.title}</h3>
                                        <p class="text-xs text-gray-400 mt-1">Asked by ${author?.name || 'Unknown'}</p>
                                    </div>
                                    <div class="text-center w-20">
                                        <div class="font-bold text-white">${question.answers?.length || 0}</div>
                                        <div class="text-xs text-gray-400">replies</div>
                                    </div>
                                </div>
                            </a>
                            `
                        }).join('') : '<p class="text-gray-400">No questions in this category yet.</p>'}
                    </div>
                `;
            }

            function renderQuestionDetailPage(questionId) {
                const questionDocRef = doc(db, "questions", questionId);
                
                onSnapshot(questionDocRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        pageElements.questionDetail.innerHTML = `<h1 class="text-2xl font-bold text-red-500">Question not found</h1>`;
                        return;
                    }
                    const q = { id: docSnap.id, ...docSnap.data() };
                    const author = users[q.authorId];
                    
                    const answersHTML = (q.answers || []).map((ans, index) => {
                        const ansAuthor = users[ans.by];
                        if (!ansAuthor) return '';
                        return `
                        <div class="flex space-x-4" data-answer-index="${index}">
                            <img src="${ansAuthor.avatar}" alt="${ansAuthor.name}" class="w-12 h-12 rounded-full">
                            <div class="flex-1 bg-gray-900/50 p-4 rounded-md">
                                <p>${ans.body}</p>
                                <div class="flex items-center justify-between mt-4 text-gray-400">
                                    <div class="flex items-center space-x-4">
                                        <button class="reply-to-answer-btn hover:text-white" data-username="${ansAuthor.name}">Reply</button>
                                        <button class="like-btn flex items-center space-x-1 hover:text-red-400 ${currentUser && ans.likes?.includes(currentUser.uid) ? 'liked' : ''}" data-question-id="${q.id}" data-answer-index="${index}">
                                            <i class="fa-heart ${currentUser && ans.likes?.includes(currentUser.uid) ? 'fas' : 'far'}"></i>
                                            <span>${ans.likes?.length || 0}</span>
                                        </button>
                                    </div>
                                    <div>- ${ansAuthor.name}</div>
                                </div>
                                <div class="reply-form-container mt-4 hidden"></div>
                            </div>
                        </div>`;
                    }).join('');

                    pageElements.questionDetail.innerHTML = `
                        <h1 class="text-3xl font-bold text-white mb-4">${q.title}</h1>
                        <div class="space-y-6">
                            <div class="flex space-x-4">
                                <img src="${author?.avatar}" alt="${author?.name}" class="w-12 h-12 rounded-full">
                                <div class="flex-1 bg-gray-900/50 p-4 rounded-md">
                                    <p>${q.body}</p>
                                    ${currentUser && q.authorId === currentUser.uid ? `
                                        <div class="mt-4 text-right">
                                            <button class="edit-question-btn text-xs text-blue-400 hover:underline mr-4" data-id="${q.id}">Edit</button>
                                            <button class="delete-question-btn text-xs text-red-400 hover:underline" data-id="${q.id}">Delete</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            ${answersHTML}
                            ${currentUser ? `<div class="flex space-x-4"><img src="${currentUser.avatar}" alt="Your avatar" class="w-12 h-12 rounded-full"><div class="flex-1 bg-gray-900/50 p-4 rounded-md"><textarea id="answer-textarea" class="w-full bg-gray-700 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="5" placeholder="Type your answer here..."></textarea><div class="text-right mt-2"><button class="post-answer-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md" data-id="${q.id}">Post Answer</button></div></div></div>` : `<div class="text-center text-gray-400 bg-gray-900/50 p-4 rounded-md">Please <button class="font-bold text-white hover:underline" id="login-from-reply-btn">log in</button> to post a reply.</div>`}
                        </div>`;
                });
            }
            
            async function renderMembersPage() {
                const memberList = Object.values(users);
                const sortedMembers = memberList.sort((a,b) => (b.points || 0) - (a.points || 0));
                pageElements.members.innerHTML = `
                    <h1 class="text-2xl font-bold text-white mb-4">Community Members</h1>
                    <div class="space-y-4">
                    ${sortedMembers.map(member => `
                        <a href="#" class="block bg-gray-900/50 p-4 rounded-md flex items-center space-x-4 hover:bg-gray-700/50 nav-link" data-page="userProfile" data-id="${member.id}">
                            <img src="${member.avatar}" alt="${member.name}" class="w-12 h-12 rounded-full">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white">${member.name}</h3>
                                <p class="text-gray-400">${member.affiliation || member.level || 'Member'}</p>
                            </div>
                            <span class="text-sm font-semibold text-white">${member.points || 'N/A'} Points Earned</span>
                        </a>
                    `).join('')}
                    </div>
                `;
            }

            async function renderUserProfilePage(userId) {
                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    pageElements.userProfile.innerHTML = `<h1 class="text-2xl font-bold text-red-500">User Not Found</h1>`;
                    return;
                }
                const user = { id: userDocSnap.id, ...userDocSnap.data() };
                const isCurrentUserProfile = currentUser && user.id === currentUser.uid;
                
                const questionsQuery = query(collection(db, "questions"), where("authorId", "==", userId));
                const questionsSnapshot = await getDocs(questionsQuery);
                const userQuestionsCount = questionsSnapshot.size;

                pageElements.userProfile.innerHTML = `
                    <div class="bg-gray-900/50 rounded-md">
                        <div class="h-32 bg-blue-800 rounded-t-md"></div>
                        <div class="p-6">
                            <div class="flex items-end -mt-16">
                                <img src="${user.avatar}" class="w-24 h-24 rounded-full border-4 border-gray-800">
                                <div class="ml-4 flex-1">
                                    <h2 class="text-2xl font-bold text-white">${user.name}</h2>
                                    <p class="text-gray-400">${user.level}</p>
                                </div>
                                ${isCurrentUserProfile ? `<button id="edit-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-md">Edit Profile</button>` : ''}
                            </div>
                            <div class="mt-6 border-t border-gray-700 pt-6">
                                <p class="text-gray-300">${user.description || 'No description provided.'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-gray-900/50 rounded-md p-6">
                                <h3 class="text-lg font-bold text-white mb-4">Stats</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                                    <div><div class="text-xl font-bold text-white">${user.points || 'N/A'}</div><div class="text-xs text-gray-400 uppercase">Points Earned</div></div>
                                    <div><div class="text-xl font-bold text-white">${userQuestionsCount}</div><div class="text-xs text-gray-400 uppercase">Questions</div></div>
                                    <div><div class="text-xl font-bold text-white">${user.answers || 'N/A'}</div><div class="text-xs text-gray-400 uppercase">Answers</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-gray-900/50 rounded-md p-6">
                                <h3 class="text-lg font-bold text-white mb-4">Details</h3>
                                <ul class="space-y-2 text-gray-300">
                                    <li><strong class="font-semibold text-gray-400">Role:</strong> ${user.isMentor ? 'Mentor' : 'Student'}</li>
                                    <li><strong class="font-semibold text-gray-400">College:</strong> ${user.collegeName || 'N/A'}</li>
                                    <li><strong class="font-semibold text-gray-400">Department:</strong> ${user.department || 'N/A'}</li>
                                    <li><strong class="font-semibold text-gray-400">Class:</strong> ${user.className || 'N/A'}</li>
                                    <li><strong class="font-semibold text-gray-400">Mentor:</strong> ${user.mentorName || 'None'}</li>
                                    <li><strong class="font-semibold text-gray-400">Collaboration:</strong> <span class="${user.wantsToCollaborate ? 'text-green-400' : 'text-red-400'}">${user.wantsToCollaborate ? 'Open to collaboration' : 'Not looking'}</span></li>
                                </ul>
                            </div>
                            <div class="bg-gray-900/50 rounded-md p-6">
                                 <h3 class="text-lg font-bold text-white mb-4">Certifications</h3>
                                <ul class="space-y-2">
                                    ${(user.certifications || []).map(cert => `<li><a href="${cert.fileURL}" target="_blank" class="text-blue-400 hover:underline">${cert.name}</a></li>`).join('') || '<p class="text-gray-400">No certifications listed.</p>'}
                                </ul>
                            </div>
                        </div>
                    </div>`;
            }

            async function renderFacultyCornerPage() {
                const page = pageElements.facultyCorner;
                const q = query(collection(db, "users"), where("isMentor", "==", true));
                const querySnapshot = await getDocs(q);
                const mentors = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                page.innerHTML = `
                    <h1 class="text-3xl font-bold text-white mb-6">Faculty Corner</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${mentors.length > 0 ? mentors.map(mentor => `
                            <div class="bg-gray-900/50 rounded-lg p-6 flex flex-col">
                                <div class="flex items-center mb-4">
                                    <img src="${mentor.avatar}" alt="${mentor.name}" class="w-16 h-16 rounded-full mr-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-white">${mentor.name}</h3>
                                        <p class="text-gray-400">${mentor.department || 'No Department'}</p>
                                    </div>
                                </div>
                                <p class="text-gray-300 flex-1 mb-4">${mentor.description || 'No description available.'}</p>
                                <div class="mt-auto flex space-x-2">
                                    <a href="#" class="flex-1 text-center bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md nav-link" data-page="userProfile" data-id="${mentor.id}">View Profile</a>
                                    <button class="flex-1 message-faculty-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md" data-id="${mentor.id}" data-name="${mentor.name}">Message</button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-400 col-span-full">No mentors have registered yet.</p>'}
                    </div>
                `;
            }

            async function renderResearchPapersPage() {
                const page = pageElements.researchPapers;
                const papersSnapshot = await getDocs(collection(db, "papers"));
                const papers = papersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                page.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-white">Research Papers</h1>
                        <button id="upload-paper-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Upload Paper</button>
                    </div>
                    <div class="space-y-4">
                        ${papers.length > 0 ? papers.map(paper => {
                            const author = users[paper.authorId];
                            return `
                            <a href="#" class="block bg-gray-900/50 p-4 rounded-md hover:bg-gray-700/50 nav-link" data-page="researchPaperDetail" data-id="${paper.id}">
                                <h3 class="font-semibold text-white">${paper.title}</h3>
                                <p class="text-xs text-gray-400 mt-1">By ${author?.name || 'Unknown'} on ${new Date(paper.publishDate).toLocaleDateString()}</p>
                            </a>
                            `
                        }).join('') : '<p class="text-gray-400">No research papers have been uploaded yet.</p>'}
                    </div>
                `;
            }

            function renderResearchPaperDetailPage(paperId) {
                const page = pageElements.researchPaperDetail;
                const paperDocRef = doc(db, "papers", paperId);
                
                onSnapshot(paperDocRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        page.innerHTML = `<h1 class="text-2xl font-bold text-red-500">Paper not found</h1>`;
                        return;
                    }

                    const paper = { id: docSnap.id, ...docSnap.data() };
                    const author = users[paper.authorId];

                    const commentsHTML = (paper.comments || []).map((comment) => {
                        const commentAuthor = users[comment.by];
                        if (!commentAuthor) return '';
                        return `
                        <div class="flex space-x-4">
                            <img src="${commentAuthor.avatar}" alt="${commentAuthor.name}" class="w-10 h-10 rounded-full">
                            <div class="flex-1 bg-gray-800 p-3 rounded-md">
                                <p class="font-semibold text-white">${commentAuthor.name}</p>
                                <p class="text-gray-300">${comment.body}</p>
                            </div>
                        </div>`;
                    }).join('');

                    page.innerHTML = `
                        <div class="bg-gray-900/50 rounded-lg p-8">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h1 class="text-3xl font-bold text-white mb-2">${paper.title}</h1>
                                    <div class="text-gray-400 mb-6">
                                        <p>By <a href="#" class="text-blue-400 hover:underline nav-link" data-page="userProfile" data-id="${paper.authorId}">${author?.name || 'Unknown'}</a></p>
                                        <p>Published on: ${new Date(paper.publishDate).toLocaleDateString()}</p>
                                        ${paper.mentor ? `<p>Mentor: ${paper.mentor}</p>` : ''}
                                    </div>
                                </div>
                                ${currentUser && paper.authorId === currentUser.uid ? `
                                    <div class="flex space-x-2">
                                        <button class="edit-paper-btn text-sm text-blue-400 hover:underline" data-id="${paper.id}">Edit</button>
                                        <button class="delete-paper-btn text-sm text-red-400 hover:underline" data-id="${paper.id}">Delete</button>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="prose prose-invert max-w-none text-gray-300 whitespace-pre-wrap">${paper.content}</div>
                        </div>

                        <div class="mt-8">
                            <h2 class="text-2xl font-bold text-white mb-4">Discussion</h2>
                            <div class="space-y-4 mb-6">
                                ${commentsHTML || '<p class="text-gray-400">No comments yet. Start the discussion!</p>'}
                            </div>
                            ${currentUser ? `
                                <div class="flex space-x-4">
                                    <img src="${currentUser.avatar}" alt="Your avatar" class="w-12 h-12 rounded-full">
                                    <div class="flex-1">
                                        <textarea id="paper-comment-textarea" class="w-full bg-gray-700 text-white rounded-md p-2" rows="3" placeholder="Add to the discussion..."></textarea>
                                        <div class="text-right mt-2">
                                            <button class="post-paper-comment-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md" data-id="${paper.id}">Post Comment</button>
                                        </div>
                                    </div>
                                </div>
                            ` : `<div class="text-center text-gray-400 bg-gray-900/50 p-4 rounded-md">Please <button class="font-bold text-white hover:underline" id="login-btn">log in</button> to join the discussion.</div>`}
                        </div>
                    `;
                });
            }

            // --- MORE RENDER FUNCTIONS FOR NEW FEATURES ---

            async function renderDocsPage() {
                const page = pageElements.docs;
                const docsSnapshot = await getDocs(collection(db, "docs"));
                const docs = docsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                page.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-white">Docs</h1>
                        <button id="upload-doc-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Upload Content</button>
                    </div>
                    <div class="space-y-4">
                        ${docs.length > 0 ? docs.map(doc => {
                            const author = users[doc.authorId];
                            return `<a href="#" class="block bg-gray-900/50 p-4 rounded-md hover:bg-gray-700/50 nav-link" data-page="docDetail" data-id="${doc.id}">
                                <h3 class="font-semibold text-white">${doc.title}</h3>
                                <p class="text-xs text-gray-400 mt-1">By ${author?.name || 'Unknown'}</p>
                            </a>`
                        }).join('') : '<p class="text-gray-400">No learning content has been uploaded yet.</p>'}
                    </div>
                `;
            }

            async function renderDocDetailPage(docId) {
                const page = pageElements.docDetail;
                const docRef = doc(db, "docs", docId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    page.innerHTML = `<h1 class="text-2xl font-bold text-red-500">Document not found</h1>`;
                    return;
                }
                const docData = docSnap.data();
                const author = users[docData.authorId];
                page.innerHTML = `
                    <div class="bg-gray-900/50 rounded-lg p-8">
                        <h1 class="text-3xl font-bold text-white mb-2">${docData.title}</h1>
                        <p class="text-gray-400 mb-6">By <a href="#" class="text-blue-400 hover:underline nav-link" data-page="userProfile" data-id="${docData.authorId}">${author?.name || 'Unknown'}</a></p>
                        <div class="prose prose-invert max-w-none text-gray-300 whitespace-pre-wrap">${docData.content}</div>
                    </div>
                `;
            }

            async function renderNewsPage() {
                const page = pageElements.news;
                const newsSnapshot = await getDocs(collection(db, "news"));
                const newsItems = newsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 page.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-white">News</h1>
                        <button id="post-news-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Post News</button>
                    </div>
                    <div class="space-y-4">
                        ${newsItems.length > 0 ? newsItems.map(item => {
                            const author = users[item.authorId];
                            return `<a href="#" class="block bg-gray-900/50 p-4 rounded-md hover:bg-gray-700/50 nav-link" data-page="newsDetail" data-id="${item.id}">
                                <h3 class="font-semibold text-white">${item.title}</h3>
                                <p class="text-xs text-gray-400 mt-1">By ${author?.name || 'Unknown'}</p>
                            </a>`
                        }).join('') : '<p class="text-gray-400">No news has been posted yet.</p>'}
                    </div>
                `;
            }
            
            async function renderNewsDetailPage(newsId) {
                const page = pageElements.newsDetail;
                const newsRef = doc(db, "news", newsId);
                const newsSnap = await getDoc(newsRef);
                if (!newsSnap.exists()) {
                    page.innerHTML = `<h1 class="text-2xl font-bold text-red-500">News item not found</h1>`;
                    return;
                }
                const newsData = newsSnap.data();
                const author = users[newsData.authorId];
                page.innerHTML = `
                    <div class="bg-gray-900/50 rounded-lg p-8">
                        <h1 class="text-3xl font-bold text-white mb-2">${newsData.title}</h1>
                        <p class="text-gray-400 mb-6">By <a href="#" class="text-blue-400 hover:underline nav-link" data-page="userProfile" data-id="${newsData.authorId}">${author?.name || 'Unknown'}</a></p>
                        ${newsData.sourceURL ? `<p class="mb-4"><a href="${newsData.sourceURL}" target="_blank" class="text-blue-400 hover:underline">Read original source</a></p>` : ''}
                        <div class="prose prose-invert max-w-none text-gray-300 whitespace-pre-wrap">${newsData.content}</div>
                    </div>
                `;
            }

            async function renderTeamFinderPage() {
                const page = pageElements.team;
                const teamsSnapshot = await getDocs(collection(db, "teams"));
                const teams = teamsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                page.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-white">Team Finder</h1>
                        <button id="create-team-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Create a Team</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${teams.length > 0 ? teams.map(team => {
                            const creator = users[team.creatorId];
                            const isInterested = currentUser && team.interestedMembers.some(m => m.uid === currentUser.uid);
                            const isCreator = currentUser && team.creatorId === currentUser.uid;
                            return `
                            <div class="bg-gray-900/50 rounded-lg p-6 flex flex-col">
                                <h3 class="text-xl font-bold text-white mb-2">${team.projectTitle}</h3>
                                <p class="text-sm text-gray-400 mb-4">Created by ${creator?.name || 'Unknown'}</p>
                                <p class="text-gray-300 flex-1 mb-4">${team.description}</p>
                                <div class="mb-4">
                                    <h4 class="font-semibold text-white mb-2">Interested Members (${team.interestedMembers.length})</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${team.interestedMembers.map(m => `<span class="bg-gray-700 text-xs font-semibold px-2 py-1 rounded-full">${m.name}</span>`).join('') || '<p class="text-xs text-gray-500">No one yet.</p>'}
                                    </div>
                                </div>
                                <button class="express-interest-btn w-full mt-auto ${isInterested || isCreator ? 'bg-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'} text-white font-semibold py-2 px-4 rounded-md" data-id="${team.id}" ${isInterested || isCreator ? 'disabled' : ''}>
                                    ${isCreator ? 'You are the creator' : (isInterested ? 'Interest Expressed' : 'Express Interest')}
                                </button>
                            </div>
                            `
                        }).join('') : '<p class="text-gray-400 col-span-full">No teams have been created yet. Be the first!</p>'}
                    </div>
                `;
            }

            async function renderLeaderboardPage() {
                const page = pageElements.leaderboard;
                const leaderboardSnapshot = await getDocs(collection(db, "leaderboard"));
                const leaderboardData = leaderboardSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Simple sort by topics created for now
                leaderboardData.sort((a, b) => b.topicsCreated - a.topicsCreated);

                page.innerHTML = `
                    <h1 class="text-3xl font-bold text-white mb-6">Leaderboard</h1>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-gray-900/50 rounded-lg">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-4">Rank</th>
                                    <th class="text-left p-4">User</th>
                                    <th class="text-center p-4">Topics Created</th>
                                    <th class="text-center p-4">Replies Posted</th>
                                    <th class="text-center p-4">Solutions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaderboardData.map((entry, index) => `
                                    <tr class="border-b border-gray-800">
                                        <td class="p-4 font-bold">${index + 1}</td>
                                        <td class="p-4 flex items-center">
                                            <img src="${entry.avatar}" class="w-8 h-8 rounded-full mr-3">
                                            <span>${entry.name}</span>
                                        </td>
                                        <td class="text-center p-4">${entry.topicsCreated}</td>
                                        <td class="text-center p-4">${entry.repliesPosted}</td>
                                        <td class="text-center p-4">${entry.solutions}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }


            function renderModals() {
                document.getElementById('signUpModal').innerHTML = `<form id="signup-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-md"><h2 class="text-2xl font-bold text-white mb-4">Create Account</h2><div class="mb-4"><label class="block text-gray-400 mb-1">Email</label><input type="email" name="email" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Password</label><input type="password" name="password" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></div><p class="text-red-400 text-sm mb-4 h-5" id="signup-error"></p><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Sign Up</button></div></form>`;
                document.getElementById('logInModal').innerHTML = `<form id="login-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-md"><h2 class="text-2xl font-bold text-white mb-4">Log In</h2><div class="mb-4"><label class="block text-gray-400 mb-1">Email</label><input type="email" name="email" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Password</label><input type="password" name="password" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></div><p class="text-red-400 text-sm mb-4 h-5" id="login-error"></p><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Log In</button></div></form>`;
                document.getElementById('editProfileModal').innerHTML = `<form id="edit-profile-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-2xl space-y-4"></form>`;
                document.getElementById('askQuestionModal').innerHTML = `<form id="ask-question-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-2xl"><h2 class="text-2xl font-bold text-white mb-4">Ask a Question</h2><div class="mb-4"><label class="block text-gray-400 mb-1">Title</label><input type="text" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Category</label><select id="ask-question-category" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2"></select></div><div class="mb-4"><label class="block text-gray-400 mb-1">Body</label><textarea rows="6" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></textarea></div><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Post</button></div></form>`;
                document.getElementById('messageFacultyModal').innerHTML = `<form id="message-faculty-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-2xl"><h2 id="message-faculty-title" class="text-2xl font-bold text-white mb-4">Message Faculty</h2><input type="hidden" name="recipientId"><div class="mb-4"><label class="block text-gray-400 mb-1">Subject</label><input type="text" name="subject" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Message</label><textarea name="body" rows="6" class="w-full bg-gray-700 rounded p-2 focus:outline-none ring-blue-500 focus:ring-2" required></textarea></div><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Send Message</button></div></form>`;
                document.getElementById('uploadPaperModal').innerHTML = `<form id="upload-paper-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-3xl"><h2 class="text-2xl font-bold text-white mb-4">Upload Research Paper</h2><div class="mb-4"><label class="block text-gray-400 mb-1">Title</label><input type="text" name="title" class="w-full bg-gray-700 rounded p-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Publish Date</label><input type="date" name="publishDate" class="w-full bg-gray-700 rounded p-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Mentor (if any)</label><input type="text" name="mentor" class="w-full bg-gray-700 rounded p-2"></div><div class="mb-4"><label class="block text-gray-400 mb-1">Content (paste here)</label><textarea name="content" rows="10" class="w-full bg-gray-700 rounded p-2" required></textarea></div><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Submit Paper</button></div></form>`;
                document.getElementById('editPaperModal').innerHTML = `<form id="edit-paper-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-3xl"><h2 class="text-2xl font-bold text-white mb-4">Edit Research Paper</h2><input type="hidden" name="paperId"><div class="mb-4"><label class="block text-gray-400 mb-1">Title</label><input type="text" name="title" class="w-full bg-gray-700 rounded p-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Publish Date</label><input type="date" name="publishDate" class="w-full bg-gray-700 rounded p-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Mentor (if any)</label><input type="text" name="mentor" class="w-full bg-gray-700 rounded p-2"></div><div class="mb-4"><label class="block text-gray-400 mb-1">Content (paste here)</label><textarea name="content" rows="10" class="w-full bg-gray-700 rounded p-2" required></textarea></div><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Save Changes</button></div></form>`;
                document.getElementById('uploadDocModal').innerHTML = `<form id="upload-doc-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-3xl"><h2 class="text-2xl font-bold text-white mb-4">Upload Learning Content</h2><div class="mb-4"><label class="block text-gray-400 mb-1">Title</label><input type="text" name="title" class="w-full bg-gray-700 rounded p-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Content</label><textarea name="content" rows="10" class="w-full bg-gray-700 rounded p-2" required></textarea></div><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Upload</button></div></form>`;
                document.getElementById('postNewsModal').innerHTML = `<form id="post-news-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-3xl"><h2 class="text-2xl font-bold text-white mb-4">Post News</h2><div class="mb-4"><label class="block text-gray-400 mb-1">Title</label><input type="text" name="title" class="w-full bg-gray-700 rounded p-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Source URL (optional)</label><input type="url" name="sourceURL" class="w-full bg-gray-700 rounded p-2"></div><div class="mb-4"><label class="block text-gray-400 mb-1">Content</label><textarea name="content" rows="8" class="w-full bg-gray-700 rounded p-2" required></textarea></div><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Post</button></div></form>`;
                document.getElementById('createTeamModal').innerHTML = `<form id="create-team-form" class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-2xl"><h2 class="text-2xl font-bold text-white mb-4">Create a Team</h2><div class="mb-4"><label class="block text-gray-400 mb-1">Project Title</label><input type="text" name="projectTitle" class="w-full bg-gray-700 rounded p-2" required></div><div class="mb-4"><label class="block text-gray-400 mb-1">Description</label><textarea name="description" rows="5" class="w-full bg-gray-700 rounded p-2" required></textarea></div><div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Create Team</button></div></form>`;
                document.getElementById('docViewerModal').innerHTML = `<div class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-4xl h-5/6 flex flex-col"><h2 id="doc-modal-title" class="text-2xl font-bold text-white mb-4">Document Viewer</h2><div id="doc-modal-content" class="flex-1 overflow-y-auto bg-gray-900/50 p-4 rounded prose prose-invert max-w-none"></div><div class="flex justify-end mt-4"><button type="button" class="modal-cancel-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Close</button></div></div>`;
                document.getElementById('messageModal').innerHTML = `<div class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-md"><h3 id="message-modal-title" class="text-2xl font-bold text-white mb-4">Message</h3><p id="message-modal-content" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button type="button" class="modal-cancel-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">OK</button></div></div>`;
                document.getElementById('confirmModal').innerHTML = `<div class="bg-gray-800 border border-gray-700 rounded-lg p-8 w-full max-w-md"><h3 id="confirm-modal-title" class="text-2xl font-bold text-white mb-4">Are you sure?</h3><p id="confirm-modal-content" class="text-gray-300 mb-6"></p><div class="flex justify-end space-x-4"><button type="button" id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="button" id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md">Confirm</button></div></div>`;
            }

            function showMessage(title, content) {
                document.getElementById('message-modal-title').textContent = title;
                document.getElementById('message-modal-content').textContent = content;
                document.getElementById('messageModal').classList.replace('hidden', 'flex');
            }

            function showConfirm(title, content, onConfirm) {
                const modal = document.getElementById('confirmModal');
                modal.querySelector('#confirm-modal-title').textContent = title;
                modal.querySelector('#confirm-modal-content').textContent = content;
                modal.classList.replace('hidden', 'flex');

                const confirmOkBtn = document.getElementById('confirm-ok-btn');
                const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                const handleConfirm = () => {
                    onConfirm();
                    modal.classList.replace('flex', 'hidden');
                    cleanup();
                }
                
                const handleCancel = () => {
                    modal.classList.replace('flex', 'hidden');
                    cleanup();
                }

                const cleanup = () => {
                    confirmOkBtn.removeEventListener('click', handleConfirm);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                }

                confirmOkBtn.addEventListener('click', handleConfirm);
                confirmCancelBtn.addEventListener('click', handleCancel);
            }

            function renderHelperBot() {
                const botLinks = document.getElementById('helper-bot-links');
                const links = [ { page: 'facultyCorner', name: 'Faculty' }, { page: 'researchPapers', name: 'Papers' }, { page: 'docs', name: 'Docs' }, { page: 'news', name: 'News' }, { page: 'team', name: 'Teams' }, { page: 'challenges', name: 'Challenges' }];
                botLinks.innerHTML = links.map(link => `<a href="#" class="nav-link bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-2 rounded-md" data-page="${link.page}">${link.name}</a>`).join('');
            }

            async function navigateTo(pageKey, dataId = null) {
                const lastPage = pageHistory[pageHistory.length - 1];
                if (lastPage.page !== pageKey || lastPage.id !== dataId) {
                    pageHistory.push({page: pageKey, id: dataId});
                }

                Object.values(pageElements).forEach(p => p.classList.remove('active'));
                const targetPage = pageElements[pageKey] || pageElements.home;
                targetPage.classList.add('active');
                
                document.querySelectorAll('.sidebar-link').forEach(link => { 
                    link.classList.remove('active'); 
                    if (link.dataset.page === pageKey && link.dataset.id === dataId) {
                        link.classList.add('active');
                    } else if (link.dataset.page === pageKey && !link.dataset.id) {
                         link.classList.add('active');
                    }
                });
                
                const backButton = document.querySelector('.go-back-btn');
                backButton.style.display = (pageKey === 'home') ? 'none' : 'flex';
                
                await fetchAllData();

                switch (pageKey) {
                    case 'home': await renderHomePage(); break;
                    case 'questionList': await renderQuestionListPage(dataId); break;
                    case 'questionDetail': renderQuestionDetailPage(dataId); break;
                    case 'members': await renderMembersPage(); break;
                    case 'userProfile': await renderUserProfilePage(dataId); break;
                    case 'facultyCorner': await renderFacultyCornerPage(); break;
                    case 'researchPapers': await renderResearchPapersPage(); break;
                    case 'researchPaperDetail': renderResearchPaperDetailPage(dataId); break;
                    case 'docs': await renderDocsPage(); break;
                    case 'docDetail': await renderDocDetailPage(dataId); break;
                    case 'news': await renderNewsPage(); break;
                    case 'newsDetail': await renderNewsDetailPage(dataId); break;
                    case 'team': await renderTeamFinderPage(); break;
                    case 'leaderboard': await renderLeaderboardPage(); break;
                    default: await renderHomePage(); break;
                }
            }
            
            // --- EVENT LISTENERS ---

            document.querySelector('.go-back-btn').addEventListener('click', () => {
                if (pageHistory.length > 1) {
                    pageHistory.pop();
                    const lastPage = pageHistory[pageHistory.length - 1];
                    navigateTo(lastPage.page, lastPage.id);
                }
            });

            document.body.addEventListener('click', async e => {
                const navLink = e.target.closest('.nav-link');
                if (navLink) { e.preventDefault(); navigateTo(navLink.dataset.page, navLink.dataset.id); }

                const modalCancelBtn = e.target.closest('.modal-cancel-btn');
                if (modalCancelBtn) { modalCancelBtn.closest('.fixed').classList.replace('flex', 'hidden'); }
                
                if (e.target.id === 'signup-btn') { document.getElementById('signUpModal').classList.replace('hidden', 'flex'); }
                if (e.target.id === 'login-btn' || e.target.id === 'login-from-reply-btn') { document.getElementById('logInModal').classList.replace('hidden', 'flex'); }
                if (e.target.id === 'logout-btn') { await signOut(auth); }

                if (e.target.id === 'edit-profile-btn') {
                    const form = document.getElementById('edit-profile-form');
                    form.innerHTML = `
                        <h2 class="text-2xl font-bold text-white">Edit Profile</h2>
                        <div><label class="block text-gray-400 mb-1">Name</label><input type="text" name="name" class="w-full bg-gray-700 rounded p-2" value="${currentUser.name || ''}"></div>
                        <div><label class="block text-gray-400 mb-1">College</label><input type="text" name="collegeName" class="w-full bg-gray-700 rounded p-2" value="${currentUser.collegeName || ''}"></div>
                        <div><label class="block text-gray-400 mb-1">Department</label><input type="text" name="department" class="w-full bg-gray-700 rounded p-2" value="${currentUser.department || ''}"></div>
                        <div><label class="block text-gray-400 mb-1">Class</label><input type="text" name="className" class="w-full bg-gray-700 rounded p-2" value="${currentUser.className || ''}"></div>
                        <div><label class="block text-gray-400 mb-1">Mentor</label><input type="text" name="mentorName" class="w-full bg-gray-700 rounded p-2" value="${currentUser.mentorName || ''}"></div>
                        <div><label class="block text-gray-400 mb-1">Collaboration</label><select name="wantsToCollaborate" class="w-full bg-gray-700 rounded p-2"><option value="true" ${currentUser.wantsToCollaborate ? 'selected' : ''}>Looking for collaboration</option><option value="false" ${!currentUser.wantsToCollaborate ? 'selected' : ''}>Not looking</option></select></div>
                        <div><label class="block text-gray-400 mb-1">Role</label><select name="isMentor" class="w-full bg-gray-700 rounded p-2"><option value="true" ${currentUser.isMentor ? 'selected' : ''}>I am a mentor/faculty</option><option value="false" ${!currentUser.isMentor ? 'selected' : ''}>I am a student</option></select></div>
                        <div class="flex justify-end space-x-4"><button type="button" class="modal-cancel-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Save Changes</button></div>
                    `;
                    document.getElementById('editProfileModal').classList.replace('hidden', 'flex');
                }

                const messageFacultyBtn = e.target.closest('.message-faculty-btn');
                if (messageFacultyBtn) {
                    if (!currentUser) {
                        showMessage('Login Required', 'Please log in to message a faculty member.');
                        return;
                    }
                    const recipientId = messageFacultyBtn.dataset.id;
                    const recipientName = messageFacultyBtn.dataset.name;
                    const modal = document.getElementById('messageFacultyModal');
                    modal.querySelector('#message-faculty-title').textContent = `Message ${recipientName}`;
                    modal.querySelector('input[name="recipientId"]').value = recipientId;
                    modal.classList.replace('hidden', 'flex');
                }

                if (e.target.id === 'upload-paper-btn') {
                    if (!currentUser) { showMessage('Login Required', 'Please log in to upload a paper.'); return; }
                    document.getElementById('uploadPaperModal').classList.replace('hidden', 'flex');
                }
                
                if (e.target.id === 'upload-doc-btn') {
                    if (!currentUser) { showMessage('Login Required', 'Please log in to upload content.'); return; }
                    document.getElementById('uploadDocModal').classList.replace('hidden', 'flex');
                }

                if (e.target.id === 'post-news-btn') {
                    if (!currentUser) { showMessage('Login Required', 'Please log in to post news.'); return; }
                    document.getElementById('postNewsModal').classList.replace('hidden', 'flex');
                }
                
                if (e.target.id === 'create-team-btn') {
                    if (!currentUser) { showMessage('Login Required', 'Please log in to create a team.'); return; }
                    document.getElementById('createTeamModal').classList.replace('hidden', 'flex');
                }

                const expressInterestBtn = e.target.closest('.express-interest-btn');
                if (expressInterestBtn) {
                    if (!currentUser) { showMessage('Login Required', 'Please log in to express interest.'); return; }
                    const teamId = expressInterestBtn.dataset.id;
                    const teamDocRef = doc(db, "teams", teamId);
                    await updateDoc(teamDocRef, {
                        interestedMembers: arrayUnion({ uid: currentUser.uid, name: currentUser.name })
                    });
                    renderTeamFinderPage(); // Re-render to update button state
                }
                
                const editPaperBtn = e.target.closest('.edit-paper-btn');
                if (editPaperBtn) {
                    const paperId = editPaperBtn.dataset.id;
                    const paperDoc = await getDoc(doc(db, "papers", paperId));
                    if (paperDoc.exists()) {
                        const paper = paperDoc.data();
                        const form = document.getElementById('edit-paper-form');
                        form.paperId.value = paperId;
                        form.title.value = paper.title;
                        form.publishDate.value = paper.publishDate;
                        form.mentor.value = paper.mentor || '';
                        form.content.value = paper.content;
                        document.getElementById('editPaperModal').classList.replace('hidden', 'flex');
                    }
                }

                const deletePaperBtn = e.target.closest('.delete-paper-btn');
                if(deletePaperBtn) {
                    const paperId = deletePaperBtn.dataset.id;
                    showConfirm("Delete Paper?", "Are you sure you want to delete this paper? This cannot be undone.", async () => {
                        await deleteDoc(doc(db, "papers", paperId));
                        showMessage("Success", "Paper has been deleted.");
                        navigateTo('researchPapers');
                    });
                }

                if (e.target.closest('#ask-question-header-btn')) { 
                    if (!currentUser) {
                        showMessage('Authentication Required', 'Please log in or sign up to ask a question.');
                        return;
                    }
                    const categorySelect = document.getElementById('ask-question-category');
                    const categoriesSnapshot = await getDocs(collection(db, "categories"));
                    categorySelect.innerHTML = categoriesSnapshot.docs.map(doc => `<option value="${doc.id}">${doc.data().name}</option>`).join('');
                    document.getElementById('askQuestionModal').classList.replace('hidden', 'flex'); 
                }
                
                const postAnswerBtn = e.target.closest('.post-answer-btn');
                if (postAnswerBtn) {
                    if (!currentUser) return; 
                    const questionId = postAnswerBtn.dataset.id;
                    const answerText = document.getElementById('answer-textarea').value;
                    if (answerText.trim() !== '') {
                        const questionDocRef = doc(db, "questions", questionId);
                        const newAnswer = { 
                            by: currentUser.uid, 
                            body: answerText, 
                            createdAt: new Date(), // FIX: Use new Date() instead of serverTimestamp()
                            likes: [] 
                        };
                        await updateDoc(questionDocRef, { answers: arrayUnion(newAnswer) });
                        document.getElementById('answer-textarea').value = '';
                    }
                }

                const postPaperCommentBtn = e.target.closest('.post-paper-comment-btn');
                if (postPaperCommentBtn) {
                    if (!currentUser) return;
                    const paperId = postPaperCommentBtn.dataset.id;
                    const commentText = document.getElementById('paper-comment-textarea').value;
                    if (commentText.trim() !== '') {
                        const paperDocRef = doc(db, "papers", paperId);
                        const newComment = {
                            by: currentUser.uid,
                            body: commentText,
                            createdAt: new Date()
                        };
                        await updateDoc(paperDocRef, { comments: arrayUnion(newComment) });
                        document.getElementById('paper-comment-textarea').value = '';
                    }
                }

                const likeBtn = e.target.closest('.like-btn');
                if (likeBtn) {
                    if (!currentUser) {
                        showMessage('Authentication Required', 'Please log in to like answers.');
                        return;
                    }
                    const questionId = likeBtn.dataset.questionId;
                    const answerIndex = parseInt(likeBtn.dataset.answerIndex);
                    const questionDocRef = doc(db, "questions", questionId);
                    const questionDoc = await getDoc(questionDocRef);
                    const questionData = questionDoc.data();
                    const answer = questionData.answers[answerIndex];

                    if (answer.likes.includes(currentUser.uid)) {
                        answer.likes = answer.likes.filter(uid => uid !== currentUser.uid);
                    } else {
                        answer.likes.push(currentUser.uid);
                    }
                    
                    await updateDoc(questionDocRef, { answers: questionData.answers });
                }
            });

            // Delegated Form Submission Listener
            document.body.addEventListener('submit', async e => {
                e.preventDefault(); 

                switch(e.target.id) {
                    case 'signup-form': {
                        const email = e.target.email.value;
                        const password = e.target.password.value;
                        const errorEl = document.getElementById('signup-error');
                        try {
                            errorEl.textContent = '';
                            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                            const user = userCredential.user;
                            
                            const newUserProfile = {
                                name: `User-${user.uid.substring(0, 5)}`,
                                email: user.email,
                                joinDate: serverTimestamp(),
                                avatar: `https://placehold.co/64x64/7c3aed/ffffff?text=${user.email[0].toUpperCase()}`,
                                level: 'Beginner',
                                points: 0,
                                isMentor: false,
                            };
                            await setDoc(doc(db, "users", user.uid), newUserProfile);
                            
                            document.getElementById('signUpModal').classList.replace('flex', 'hidden');
                        } catch (error) {
                            errorEl.textContent = error.message;
                        }
                        break;
                    }
                    case 'login-form': {
                        const email = e.target.email.value;
                        const password = e.target.password.value;
                        const errorEl = document.getElementById('login-error');
                        try {
                            errorEl.textContent = '';
                            await signInWithEmailAndPassword(auth, email, password);
                            document.getElementById('logInModal').classList.replace('flex', 'hidden');
                        } catch (error) {
                            errorEl.textContent = "Invalid email or password.";
                        }
                        break;
                    }
                    case 'edit-profile-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const updatedProfile = {
                            name: form.name.value,
                            collegeName: form.collegeName.value,
                            department: form.department.value,
                            className: form.className.value,
                            mentorName: form.mentorName.value,
                            wantsToCollaborate: form.wantsToCollaborate.value === 'true',
                            isMentor: form.isMentor.value === 'true'
                        };
                        const userDocRef = doc(db, "users", currentUser.uid);
                        await updateDoc(userDocRef, updatedProfile);
                        currentUser = { ...currentUser, ...updatedProfile };
                        document.getElementById('editProfileModal').classList.replace('flex', 'hidden');
                        navigateTo('userProfile', currentUser.uid);
                        break;
                    }
                    case 'ask-question-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const title = form.querySelector('input[type="text"]').value;
                        const categoryId = form.querySelector('select').value;
                        const body = form.querySelector('textarea').value;
                        if (title && categoryId && body) {
                            const newQuestion = {
                                catId: categoryId,
                                title: title,
                                body: body,
                                authorId: currentUser.uid,
                                votes: 0,
                                answers: [],
                                createdAt: serverTimestamp(),
                                solved: false
                            };
                            const docRef = await addDoc(collection(db, "questions"), newQuestion);
                            form.closest('.fixed').classList.replace('flex', 'hidden');
                            form.reset();
                            navigateTo('questionDetail', docRef.id);
                        }
                        break;
                    }
                    case 'message-faculty-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const newMessage = {
                            toId: form.recipientId.value,
                            fromId: currentUser.uid,
                            fromName: currentUser.name,
                            subject: form.subject.value,
                            body: form.body.value,
                            createdAt: serverTimestamp(),
                            isRead: false
                        };
                        await addDoc(collection(db, "messages"), newMessage);
                        form.closest('.fixed').classList.replace('flex', 'hidden');
                        form.reset();
                        showMessage("Success", "Your message has been sent!");
                        break;
                    }
                    case 'upload-paper-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const newPaper = {
                            title: form.title.value,
                            publishDate: form.publishDate.value,
                            mentor: form.mentor.value,
                            content: form.content.value,
                            authorId: currentUser.uid,
                            createdAt: serverTimestamp(),
                            comments: []
                        };
                        await addDoc(collection(db, "papers"), newPaper);
                        form.closest('.fixed').classList.replace('flex', 'hidden');
                        form.reset();
                        showMessage("Success", "Your paper has been submitted!");
                        navigateTo('researchPapers');
                        break;
                    }
                    case 'edit-paper-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const paperId = form.paperId.value;
                        const updatedPaper = {
                            title: form.title.value,
                            publishDate: form.publishDate.value,
                            mentor: form.mentor.value,
                            content: form.content.value,
                        };
                        const paperDocRef = doc(db, "papers", paperId);
                        await updateDoc(paperDocRef, updatedPaper);
                        form.closest('.fixed').classList.replace('flex', 'hidden');
                        form.reset();
                        showMessage("Success", "Your paper has been updated!");
                        navigateTo('researchPaperDetail', paperId);
                        break;
                    }
                    case 'upload-doc-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const newDoc = {
                            title: form.title.value,
                            content: form.content.value,
                            authorId: currentUser.uid,
                            createdAt: serverTimestamp()
                        };
                        await addDoc(collection(db, "docs"), newDoc);
                        form.closest('.fixed').classList.replace('flex', 'hidden');
                        form.reset();
                        showMessage("Success", "Your content has been uploaded!");
                        navigateTo('docs');
                        break;
                    }
                    case 'post-news-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const newNews = {
                            title: form.title.value,
                            sourceURL: form.sourceURL.value,
                            content: form.content.value,
                            authorId: currentUser.uid,
                            createdAt: serverTimestamp()
                        };
                        await addDoc(collection(db, "news"), newNews);
                        form.closest('.fixed').classList.replace('flex', 'hidden');
                        form.reset();
                        showMessage("Success", "Your news has been posted!");
                        navigateTo('news');
                        break;
                    }
                    case 'create-team-form': {
                        if (!currentUser) return;
                        const form = e.target;
                        const newTeam = {
                            projectTitle: form.projectTitle.value,
                            description: form.description.value,
                            creatorId: currentUser.uid,
                            createdAt: serverTimestamp(),
                            interestedMembers: []
                        };
                        await addDoc(collection(db, "teams"), newTeam);
                        form.closest('.fixed').classList.replace('flex', 'hidden');
                        form.reset();
                        navigateTo('team');
                        break;
                    }
                }
            });

            // --- INITIALIZATION ---
            renderModals();
            renderHelperBot();
            // Initial UI update and navigation will happen inside onAuthStateChanged
        });
    </script>
</body>
</html>
